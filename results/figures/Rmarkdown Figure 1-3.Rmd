---
title: "Age of Return"
subtitle: "Markdown for Figures 1 - 3"
author: "Caitlin O'Brien"
date: "1/4/2023"
output:
  rmarkdown::html_document:
    theme: sandstone
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
---


Basefile wrangling
```{r, message=FALSE, error=FALSE, results='hide', class.source='fold-show'}

#packages
library(tidyverse)
library(likert)
library(lubridate)

#import data
d<-read_csv("data_adults.csv")

d<- d %>% 
   mutate_if(sapply(d,is.character), as.factor)
summary(d)

##filter data 
df<- d %>% 
  filter(length < 155,##remove fork length > 155mm for all types--removes two values (162 & 164mm, t_run = 2) plus 6 NA's
         juv_lgr_first > '1998-01-01 00:00:00' & juv_lgr_first < '2019-12-31 24:00:00',## only include 1998 to 2019 juv_lgr_first data.
         pass_type_T_R  %in% c("ROR", "T")) #filter to only include ROR and T--removes RORBD (3) and TB (4) values

#extract smolt migration year ()
d.smy<-df %>% 
  mutate_if(sapply(d,is.character), as.factor) %>% 
  mutate(smy_year = lubridate::year(juv_lgr_first)) 

```


## Figure 1. Return Numbers
Number of smolts and adults by age vs smolt migration year. 



[likert plot](https://r-graph-gallery.com/202-barplot-for-likert-type-items.html) ~  where mini-jacks and jacks are on the left, and 2-ocean, 3-ocean, etc. are on the right.

- summarize data to include age grouping based on age column: 
  - mini-jack (0-ocean) 
  - jack (1-ocean)
  - 2-ocean
  - 3-ocean
  - 4-ocean or more.
  
figure 1 data wrangling:   
```{r, message=FALSE, error=FALSE,warning=FALSE, class.source='fold-show'}
#calculate ocean age--needs updating
d.ocean<-d.smy %>% 
  filter(!is.na(adu_bon_first)) %>% #removed any adu_bon without detection----REDO this to include past adu_first data (need code)
  mutate(years_diff = time_length(difftime(adu_bon_first, juv_lgr_first), "years")) %>%  # Calculate difference in years
  mutate(ReturnAge = case_when(years_diff <1 ~ '0-Ocean', #assign value based on years_diff ( plotted strict casewhen, but updated to reflect age that grouped (i.e. 2.5 = 3yrs, see graph of years_diff to see breakdown))
                              years_diff >=1 & years_diff < 1.5 ~'1-Ocean',
                              years_diff >=1.5 & years_diff < 2.5 ~'2-Ocean',
                              years_diff >=2.5 & years_diff < 3.5 ~'3-Ocean', 
                              years_diff >= 3.5 & years_diff <5 ~'4-Ocean'))

#summarize data by return age
d.return<- d.ocean %>% 
  mutate_if(sapply(d.ocean,is.character), as.factor) %>% 
  group_by(t_run, pass_type_T_R, smy_year, ReturnAge) %>% 
  summarise( n = n())
```


```{r, message=FALSE, error=FALSE,warning=FALSE}
 #show breakdown of age by years_diff
    ggplot(d.ocean, aes(x=smy_year, y= years_diff, color=ReturnAge))+
      geom_point()
```

### Figure 1a

```{r}
#stacked bar of counts
ggplot(d.return, aes(x=as.factor(smy_year), y= n, fill=forcats::fct_rev(ReturnAge)))+
  geom_bar(position = "stack", stat="identity", width = .7)+
  labs(x="Smolt Migration Year", y= "Number of returns ", 
       color="",
       fill ="",
       title = "Proportion of returns by age and migration year",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
  scale_fill_manual(breaks = c("4-Ocean", "3-Ocean", "2-Ocean", "1-Ocean", "0-Ocean"),
                       values =c("gray","azure2","lightskyblue3", "lightskyblue4","steelblue4"))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
#proportional stacked bar
ggplot(d.return, aes(x=as.factor(smy_year), y= n, fill=forcats::fct_rev(ReturnAge)))+
  geom_bar(position = position_fill(), stat="identity")+ 
  labs(x="Smolt Migration Year", y= "Proportion of returns ", 
       color="",
       fill ="",
       title = "Proportion of returns by age and migration year",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
  scale_fill_manual(breaks = c("4-Ocean", "3-Ocean", "2-Ocean", "1-Ocean", "0-Ocean"),
                       values =c("gray","azure2","lightskyblue3", "lightskyblue4","steelblue4"))+
  scale_y_continuous(labels = scales::percent)+
  theme_classic()+ 
  theme(axis.text.x = element_text(angle = 90))
```


### Figure 1b. 
Same as Figure 1a, with transported vs in-river juvenile fish categories distinguished.

```{r}
#labels for facet grid
p.labs <- c("In-River", "Transported")
names(p.labs) <- c("ROR", "T")

#stacked bar with pass_type
ggplot(d.return, aes(x=as.factor(smy_year), y= n, fill=forcats::fct_rev(ReturnAge)))+
  geom_bar(position = "stack", stat="identity", width = .7)+
  labs(x="Smolt Migration Year", y= "Number of returns ", 
       color="",
       fill ="",
       title = "Proportion of returns by age and migration year",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
  scale_fill_manual(breaks = c("4-Ocean", "3-Ocean", "2-Ocean", "1-Ocean", "0-Ocean"),
                       values =c("gray","azure2","lightskyblue3", "lightskyblue4","steelblue4"))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90)) + facet_grid(~pass_type_T_R, labeller = labeller(pass_type_T_R = p.labs))
```


```{r}
#proportional stacked bar with transport and ROR

ggplot(d.return, aes(x=as.factor(smy_year), y= n, fill=forcats::fct_rev(ReturnAge)))+
  geom_bar(position = position_fill(), stat="identity")+ 
  labs(x="Smolt Migration Year", y= "Proportion of returns ", 
       color="",
       fill ="",
       title = "Proportion of in-river versus transported salmon returns by age and migration year",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
   scale_fill_manual(breaks = c("4-Ocean", "3-Ocean", "2-Ocean", "1-Ocean", "0-Ocean"),
                       values =c("gray","azure2","lightskyblue3", "lightskyblue4","steelblue4"))+
  scale_y_continuous(labels = scales::percent)+
  theme_classic()+ 
  theme(axis.text.x = element_text(angle = 90)) + facet_grid(~pass_type_T_R, labeller = labeller(pass_type_T_R = p.labs))

```

Likert (like) plot
```{r}
#subset and graph two times
ggplot(d.return, aes(x=as.factor(smy_year), fill=ReturnAge)) + 
      geom_bar(data = subset(d.return, ReturnAge %in% c("0-Ocean","1-Ocean")),
               aes(y = -n), position="stack", stat="identity") +
      geom_bar(data = subset(d.return, !ReturnAge %in% c("0-Ocean","1-Ocean")), 
               aes(y = n), position="stack", stat="identity")+
    labs(x="Smolt Migration Year", y= "Number of Returns", 
       color="",
       fill ="",
       title = "Number of returns by age and migration year",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
    scale_fill_manual(breaks = c("4-Ocean", "3-Ocean", "2-Ocean", "1-Ocean", "0-Ocean"),
                       values =c("gray","azure2","lightskyblue3", "lightskyblue4","steelblue4"))+
  coord_flip() + theme_classic()
```


## Figure 2. Fork Length



### Figure 2a. 
Fork length vs smolt migration year
[boxplot or violin plot, including outliers](https://r-graph-gallery.com/violin.html)

```{r}
fig.2a<-ggplot(d.smy, aes(x=as.factor(smy_year), y=length)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), 
              alpha=.2, 
              color = "grey50", 
              fill = "grey50", 
              trim = FALSE )+
   geom_hline(yintercept=mean(d.smy$length), 
              linetype="dashed", 
              color = "grey70", 
              linewidth = .5)+
  #geom_point(alpha=.25, color = "grey40", size = 1) +
  labs(x="Smolt Migration Year", 
       y= "Fork Length (mm)", 
       color=" ",
      title = "Juvenile Fish Fork length vs Smolt Migration Year",
      subtitle = "Smolt Migration Year: 1998 to 2019",
      caption = "")+
  theme_classic()+ 
  theme (legend.position = "bottom", 
         axis.text.x = element_text(angle = 90))

fig.2a
```

### Figure 2b. 
Transported vs in-river juvenile fish Fork length vs smolt migration year
  Same as Figure 2a, with  categories distinguished.

```{r}
fig.2b<-ggplot(d.smy, aes(x=as.factor(smy_year), y=length)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), 
              alpha=.2, 
              color = "grey70", 
              fill = "grey70", 
              trim = FALSE )+
   geom_hline(yintercept=mean(d.smy$length), 
              linetype="dashed", 
              color = "grey70", 
              linewidth = .5)+
  geom_point(alpha=.5, size = 1, aes(color=pass_type_T_R)) +
  labs(x="Smolt Migration Year", y= "Fork Length (mm)", 
       color="",
       title = "Transported vs In-river Juvenile Fish Fork Length (mm)",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
  scale_color_manual(breaks = c("ROR", "T"),
                     labels = c("In-River", "Transported"),
                     values = c("lemonchiffon3", "cadetblue4"))+
  theme_classic()+ 
  theme (legend.position = "top", 
                          axis.text.x = element_text(angle = 90))

fig.2b
```

### Alternatives

Alternative 2b: Individual violin graphs separated by transport type 

```{r, echo=FALSE, warning=FALSE}
#filter based on transport type
    ##transported
    d.T<- d.smy %>% 
      filter(pass_type_T_R == "T")
    
    violin.t.fork<-ggplot(d.T, aes(x=as.factor(smy_year), y=length)) +
      geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha=.2, color = "cadetblue4", fill = "cadetblue4", trim = FALSE )+
       geom_hline(yintercept=mean(d.T$length), linetype="dashed", color = "grey70", size = .5)+
      geom_point(alpha=.25, color = "cadetblue4", size = 1) +
      labs(x="Smolt Migration Year", y= "Fork Length (mm)", color=" ")+
      theme_classic()+ theme (legend.position = "bottom", axis.text.x = element_text(angle = 90))
    
    ##In-River
      d.ROR<- d.smy %>% 
        filter(pass_type_T_R == "ROR")
      
      violin.ROR.fork<-ggplot(d.ROR, aes(x=as.factor(smy_year), y=length)) +
        geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), alpha=.2, color = "lemonchiffon3", fill = "lemonchiffon3", trim = FALSE )+
         geom_hline(yintercept=mean(d.ROR$length), linetype="dashed", color = "grey70", size = .5)+
        geom_point(alpha=.25, color = "lemonchiffon3", size = 1) +
        labs(x="Smolt Migration Year", y= "Fork Length (mm)", color=" ")+
        theme_classic()+ theme (legend.position = "bottom", axis.text.x = element_text(angle = 90))

#individual graphs by transport type
violin.ROR.fork
violin.t.fork
```


Alternative 2b: Side-by-side of Transport and ROR violin graphs

```{r, echo=FALSE, warning=FALSE}
ggplot(d.smy, aes(x=as.factor(smy_year), y=length, color=pass_type_T_R, fill=pass_type_T_R)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), 
              alpha=.2, 
              
              trim = FALSE )+
   geom_hline(yintercept=mean(d.smy$length), 
              linetype="dashed", 
              color = "grey70", 
              size = .5)+
  #geom_point(alpha=.5, size = 1, aes(color=pass_type_T_R)) +
  labs(x="Smolt Migration Year", y= "Fork Length (mm)", 
       color="",
       fill ="",
       title = "Transported vs In-river Juvenile Fish Fork Length (mm)",
       subtitle = "Smolt Migration Year: 1998 to 2019",
       caption = "")+
  scale_color_manual(breaks = c("ROR", "T"),
                     labels = c("In-River", "Transported"),
                     values = c("lemonchiffon3", "cadetblue4"))+
   scale_fill_manual(breaks = c("ROR", "T"),
                     labels = c("In-River", "Transported"),
                     values = c("lemonchiffon3", "cadetblue4"))+
  theme_classic()+ 
  theme (legend.position = "top", 
                          axis.text.x = element_text(angle = 90))


```


Alternative 2b: using ridges

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
library(ggridges)
library(forcats)


  ggplot(d.smy, aes(y = forcats::fct_rev(as.factor(smy_year)))) +
  geom_density_ridges(
    aes(x = length, fill = pass_type_T_R), 
    alpha = .8, color = "white",
    jittered_points = TRUE,
    position = position_points_jitter(width = 0.05, height = 0),
    point_shape = '|', point_size = 1, point_alpha = 1, alpha = 0.7) +
     geom_vline(xintercept=mean(d.smy$length), linetype="dashed", color = "white", size = .5)+
  labs(
    x = "Fork Length (mm)",
    y = "Smolt Migration Year",
    fill ="",
    title = "Transported vs In-river Juvenile Fish Fork length",
    subtitle = "Smolt Migration Year: 1998 to 2019",
    caption = ""
  )+
  scale_fill_manual(breaks = c("ROR", "T"),
                     labels = c("In-River", "Transported"),
                     values = c("lemonchiffon3", "cadetblue4"))+  
  coord_cartesian(clip = "off") +
  theme_ridges(grid = FALSE)+theme(legend.position = "right")
```


## Figure 3. Release Location


figure 3 data wrangling
```{r, warning=FALSE, error=FALSE, message=FALSE, class.source='fold-show'}
##group and summarize to get count of returns per year>subbasin>pass_type

d.rel <-d.smy %>% 
  group_by(smy_year, subbasin, pass_type_T_R) %>% 
  summarise( count = n()) 
```

### Figure 3a. 
Proportion by release location vs. year 
[stream graph](https://r-graph-gallery.com/streamgraph.html) or [stacked area chart](https://r-graph-gallery.com/stacked-area-graph.html)


```{r}
# bar
ggplot(d.rel, aes(x=subbasin, y= count, fill=as.factor(smy_year)))+
  geom_bar(position = "fill", stat="identity")+ 
  coord_flip()
```


### Figure 3b. 
Proportion by release location vs. year of transported vs in-river juvenile fish
Same as Figure 3a, with transported vs in-river juvenile fish categories distinguished.

```{r}
ggplot(d.rel, aes(x=subbasin, y= count, fill=as.factor(smy_year)))+
  geom_bar(position = "fill", stat="identity")+ 
  coord_flip()+ facet_grid(~pass_type_T_R)
```




